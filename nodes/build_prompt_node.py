import re
from utils.prompt_utils import (
    sanitize_query_for_prompt,
    format_fewshot_examples
)
from langchain.prompts import ChatPromptTemplate

SYSTEM_INSTRUCTION = """
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç, –æ—Ü–µ–Ω–∏–≤–∞—é—â–∏–π, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É –∑–∞–ø—Ä–æ—Å—É. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –∑–¥—Ä–∞–≤—É—é, –ø—Ä–∞–∫—Ç–∏—á–Ω—É—é –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–ø–æ–ª–Ω–æ–µ. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ ‚Äî –æ—Ü–µ–Ω–∏ —Å —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏.

–ì–æ–≤–æ—Ä–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
- RELEVANT_PLUS ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —è–≤–Ω–æ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥—Ö–æ–¥–∏—Ç.
- IRRELEVANT ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–ø—Ä–æ—Å—É.
- NEED_MORE_INFO ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å –¥–∞–∂–µ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ.

üìå –ü—Ä–∞–≤–∏–ª–∞:
- –£—á–∏—Ç—ã–≤–∞–π —Å–º—ã—Å–ª –∑–∞–ø—Ä–æ—Å–∞: —Ç–µ–º–∞—Ç–∏–∫–∞, —É—Å–ª—É–≥–∏, —Ñ–æ—Ä–º–∞—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è.
- –ì–æ—Ä–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω –≤ –∑–∞–ø—Ä–æ—Å–µ.
- –ù–µ —Å—É–¥–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–¥—Ä–µ—Å—É.
- –î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–±–æ–±—â–µ–Ω–∏–µ, —É—á—ë—Ç —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –∏ —Å–º–µ–∂–Ω—ã—Ö —É—Å–ª—É–≥.

üìå –ë—É–¥—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º:
- –î–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞—è —É—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–∑–≤–∞–Ω–∞ –Ω–∞–ø—Ä—è–º—É—é.
- –ö–æ—Å–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–∑—ã–≤—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Å–º–µ–∂–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏) –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏.
- –£—Å–ª—É–≥–∏ –≤ –æ–¥–Ω–æ–π —Å—Ñ–µ—Ä–µ –º–æ–≥—É—Ç –æ–∑–Ω–∞—á–∞—Ç—å –Ω–∞–ª–∏—á–∏–µ –¥—Ä—É–≥–∏—Ö –ø–æ—Ö–æ–∂–∏—Ö ‚Äî –æ—Ü–µ–Ω–∏ —ç—Ç–æ –∑–¥—Ä–∞–≤–æ. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–µ—á–∞—Ç–∞–µ—Ç –≤–∏–∑–∏—Ç–∫–∏ –∏ –ª–∏—Å—Ç–æ–≤–∫–∏, –æ–Ω–∞, –≤–µ—Ä–æ—è—Ç–Ω–æ, –ø–µ—á–∞—Ç–∞–µ—Ç –∏ –Ω–∞–∫–ª–µ–π–∫–∏.

üìå –†–∞–±–æ—Ç–∞–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ:
- –ï—Å–ª–∏ —Å –±–æ–ª—å—à–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—É—é —É—Å–ª—É–≥—É ‚Äî —ç—Ç–æ RELEVANT_PLUS.
- –ù–µ –ø–∞–Ω–∏–∫—É–π –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å–ª–æ–≤ ‚Äî –æ—Ü–µ–Ω–∏ –ø–æ —Å–º—ã—Å–ª—É –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É.

üìå –£—á–∏—Ç—ã–≤–∞–π –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- –¢–µ—Ä–º–∏–Ω—ã, –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã: "–º—Å–∫—Ç" = "–∫—Ç", "–ø—Ü—Ä –∫–æ–≤–∏–¥" = "–ü–¶–†-—Ç–µ—Å—Ç", "—É–∑–∏ –±—Ä—é—à–∫–∏" = "–£–ó–ò –æ—Ä–≥–∞–Ω–æ–≤ –±—Ä—é—à–Ω–æ–π –ø–æ–ª–æ—Å—Ç–∏".
- –°—Ç–∞—Ä–∞–π—Å—è –ø–æ–Ω—è—Ç—å, —á—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –∏–º–µ–ª –≤ –≤–∏–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –Ω–µ –Ω–∞–∫–∞–∑—ã–≤–∞–π –∑–∞ —Ñ–æ—Ä–º—É –∑–∞–ø—Ä–æ—Å–∞.

üìå –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–µ —Å—á–∏—Ç–∞—é—Ç—Å—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –ø–æ —Å–º—ã—Å–ª—É:
- –ó–∞–ø—Ä–æ—Å "–≤–∞–∫–∞–Ω—Å–∏–∏..." —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω, –µ—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ñ–µ—Ä–µ.
- –ó–∞–ø—Ä–æ—Å—ã –ø—Ä–æ –∑–∞–ø–∏—Å—å, —Ü–µ–Ω—ã, –æ—Ç–∑—ã–≤—ã ‚Äî —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã, –µ—Å–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—É—é —É—Å–ª—É–≥—É.
- –ó–∞–ø—Ä–æ—Å "–ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ –æ–∫–Ω–∞" —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–ª–∏ –ø—Ä–æ–¥–∞–∂–∞ –æ–∫–æ–Ω.

üìå –ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å NEED_MORE_INFO:
- –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å.
- –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –Ω–∏ –æ—Ç–∑—ã–≤–æ–≤, –Ω–∏ –∫–æ—Å–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.
- –ï—Å–ª–∏ –¥–∞–∂–µ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã–º –º—ã—à–ª–µ–Ω–∏–µ–º –Ω–µ–ª—å–∑—è —É–≤–µ—Ä–µ–Ω–Ω–æ —Å–∫–∞–∑–∞—Ç—å –Ω–∏ "–¥–∞", –Ω–∏ "–Ω–µ—Ç".
‚Äì –ï—Å–ª–∏ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω—É–∂–Ω—É—é —Å—Ñ–µ—Ä—É ‚Äî –¥–∞–∂–µ –∫–æ—Å–≤–µ–Ω–Ω–æ ‚Äî —Ç—ã –æ–±—è–∑–∞–Ω –≤—ã–±—Ä–∞—Ç—å RELEVANT_PLUS –∏–ª–∏ IRRELEVANT.
–í—ã–±–∏—Ä–∞–π NEED_MORE_INFO —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
–í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚Äî –≤—ã–±–µ—Ä–∏ RELEVANT_PLUS –∏–ª–∏ IRRELEVANT, –¥–∞–∂–µ –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–º–Ω–æ–≥–æ.

üìå –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- –ë—É–¥—å —á–µ—Å—Ç–Ω—ã–º: –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –ø–æ–Ω–∏–º–∞–Ω–∏—è ‚Äî –ø—Ä—è–º–æ –ø—Ä–∏–∑–Ω–∞–π —ç—Ç–æ.
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã –∏ –∞–Ω–∞–ª–æ–≥–∏–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏, —á—Ç–æ–±—ã –ø–æ—è—Å–Ω–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
- –°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑–±–∏—Ä–∞–π –ø–æ—à–∞–≥–æ–≤–æ, –Ω–µ —Å–ø–µ—à–∏ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π, –∑–∞—Ç–µ–º —Å–¥–µ–ª–∞–π –≤—ã–≤–æ–¥.
- –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –∫–∞–∂–¥–æ–µ —Ç–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–æ ‚Äî —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–µ–¥–µ–ª—å–Ω–æ —Ç–æ—á–Ω—ã–º –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º. –ù–∞ –∫–æ–Ω—É ‚Äî –¥–æ–≤–µ—Ä–∏–µ –∏, –≤–æ–∑–º–æ–∂–Ω–æ, —Å—É–¥—å–±—ã –ª—é–¥–µ–π.

üìå –û—Ü–µ–Ω–∏–≤–∞–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–º—ã:
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –∫–∞—Å–∞—Ç—å—Å—è –≤–∑—Ä–æ—Å–ª—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–ª–∏ —É—Å–ª—É–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–µ–∫—Å-—à–æ–ø—ã, –º–∞—Å—Å–∞–∂–Ω—ã–µ —Å–∞–ª–æ–Ω—ã, —ç—Ä–æ—Ç–∏—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏ –∏ —Ç.–ø.).
- –û—Ç–Ω–æ—Å–∏—Å—å –∫ —Ç–∞–∫–∏–º —Å–ª—É—á–∞—è–º –∫–∞–∫ –∫ –æ–±—ã—á–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –±–∏–∑–Ω–µ—Å–∞ ‚Äî –Ω–µ –ø—Ä–∏–º–µ–Ω—è–π –ø—Ä–µ–¥–≤–∑—è—Ç–æ—Å—Ç—å, –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞–π –º–æ—Ä–∞–ª—å–Ω–æ.
- –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ü–µ–Ω–∏—Ç—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å—É, –±–µ–∑ —ç–º–æ—Ü–∏–π –∏ –æ—Å—É–∂–¥–µ–Ω–∏—è.

‚ö†Ô∏è –≠—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ: –Ω–µ –æ—à–∏–±–∏—Å—å –≤ –æ—Ü–µ–Ω–∫–µ. –°–¥–µ–ª–∞–π –º–∞–∫—Å–∏–º—É–º, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å —Ä–∞–∑—É–º–Ω–æ–µ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: <RELEVANT_PLUS | IRRELEVANT | NEED_MORE_INFO>
""".strip()

def build_prompt_node(state: dict) -> dict:
    """–°–æ–∑–¥–∞—ë—Ç –ø—Ä–æ–º–ø—Ç –∏ –∫–ª–∞–¥—ë—Ç –µ–≥–æ –≤ state"""
    query = sanitize_query_for_prompt(state.get("query", ""))

    org_text = f"""
        –ù–∞–∑–≤–∞–Ω–∏–µ: {state.get('name', '')}
        –ê–¥—Ä–µ—Å: {state.get('address', '')}
        –¢–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏: {state.get('prices_summarized', '')}
        –û—Ç–∑—ã–≤—ã: {state.get('reviews_summarized', '')}
    """.strip()

    if state.get("search_snippet"):
        org_text += f"\n–°–Ω–∏–ø–ø–µ—Ç: {state['search_snippet'].strip()}"

    rubric_name = state.get("normalized_main_rubric_name_ru", "")
    rubric_block = f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {rubric_name}" if rubric_name else "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –Ω–µ —É–∫–∞–∑–∞–Ω–∞"

    fewshot_block = format_fewshot_examples(
        state.get("retrieved_fewshot_examples", []) + state.get("base_fewshot_examples", [])
    )

    user_prompt = f"""–ü—Ä–∏–º–µ—Ä—ã:

        {fewshot_block}
        
        ---
        
        –ó–∞–ø—Ä–æ—Å: {query}
        –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: {org_text}
        {rubric_block}
    """

    final_prompt = ChatPromptTemplate.from_messages([
        ("system", SYSTEM_INSTRUCTION),
        ("user", user_prompt)
    ])

    return {**state, "prompt": final_prompt}

def parse_response(response: str) -> dict:
    """–ü–∞—Ä—Å–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞"""
    relevance_match = re.search(
        r"–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å:\s*(RELEVANT_PLUS|IRRELEVANT|NEED_MORE_INFO)",
        response, re.IGNORECASE
    )

    llm_label = relevance_match.group(1).strip().upper() if relevance_match else "NEED_MORE_INFO"

    return {
        "llm_label": llm_label
    }